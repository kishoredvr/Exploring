name: Keep Supabase Alive

on:
  schedule:
    # Runs at minute 0 past hour 0, 10, and 20 (UTC) every day.
    - cron: "0 */10 * * *"
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest
    steps:
      - name: Send Keep-Alive Payload
        env:
          # REQUIRED: Add this in GitHub Repo Settings -> Secrets
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          # 1. Generate Dynamic Variables to prevent DB collisions
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          UNIQUE_ID="KEEPALIVE-$(date +%s)"

          echo "----------------------------------------"
          echo "Generated Run ID: $UNIQUE_ID"
          echo "Timestamp: $TIMESTAMP"
          echo "----------------------------------------"

          # 2. Construct JSON Payload securely (Heredoc)
          # We set purpose="Other" to trigger the email logic in your TS file.
          JSON_PAYLOAD=$(cat <<EOF
          {
            "name": "KeepAlive Bot",
            "email": "keepalive@system.bot",
            "mobileNumber": "9999999999",
            "purpose": "Other",
            "astroServiceSelect": "Not applicable",
            "astro_service_tier": "Not applicable",
            "birthDetailsAvailable": "Not applicable",
            "dob": "Not applicable",
            "hour": "Not applicable",
            "minute": "Not applicable",
            "second": "Not applicable",
            "explanation": "Not applicable",
            "city": "Not applicable",
            "state": "Not applicable",
            "country": "Not applicable",
            "pincode": "Not applicable",
            "gender": "Not applicable",
            "genderOtherInput": "Not applicable",
            "accuracy": "Not applicable",
            "contactCountry": "India",
            "expectations": "Automated keep-alive request $UNIQUE_ID",
            "phonepe_txn_id": "KA-TXN-0000",
            "phonepe_order_id": "$UNIQUE_ID",
            "payment_amount": "0",
            "payment_status": "not applicable",
            "submittedAt": "$TIMESTAMP"
          }
          EOF
          )

          # 3. Send Request and Capture Full Response
          # We use curl with headers to mimic a legitimate request.
          # The -w flag captures the HTTP status code at the end.
          response=$(curl -s -w "\n%{http_code}" -X POST "https://lkvcbpxkpwpoqjlcddgl.functions.supabase.co/submit-form" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "User-Agent: GitHub-Actions-KeepAlive/1.0" \
            -H "Accept: application/json" \
            --max-time 60 \
            -d "$JSON_PAYLOAD")

          # 4. Process Response
          http_body=$(echo "$response" | sed '$d')
          http_code=$(echo "$response" | tail -n1)

          echo "----------------------------------------"
          echo "SERVER RESPONSE BODY:"
          echo "$http_body"
          echo "----------------------------------------"
          echo "HTTP STATUS CODE: $http_code"

          # 5. Fail the workflow if not 200 OK
          if [ "$http_code" -ne 200 ]; then
            echo "::error::Request failed! Server returned status $http_code"
            exit 1
          fi

          # 6. Check if body implies success (Optional additional check)
          if [[ "$http_body" != *"success"* ]]; then
             echo "::warning::Server returned 200 but body does not contain 'success'. Check logs."
          fi
