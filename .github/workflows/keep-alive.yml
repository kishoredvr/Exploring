name: Keep Alive - Daily Form Submission
on:
  schedule:
    # Runs every 24 hours at 00:00 UTC
    - cron: '0 0 * * *'
  # Also run on workflow_dispatch for manual triggering
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Send Minimal Keep-Alive Submission
        env:
          BACKEND_BASE: 'https://lkvcbpxkpwpoqjlcddgl.functions.supabase.co'
        run: |
          echo "Sending minimal keep-alive submission..."
          
          # Generate a unique timestamp for this submission
          TIMESTAMP=$(date +%s)
          DATE_ISO=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          
          # Create minimal payload matching exactly what your server accepts
          cat > dummy_data.json << EOF
          {
            "purpose": "Other",
            "name": "Keep Alive Bot",
            "email": "keep-alive-$TIMESTAMP@example.com",
            "mobileNumber": "9876543210",
            "astro_service_tier": "not applicable",
            "payment_amount": "0",
            "payment_status": "not applicable",
            "contactCountry": "Test Country",
            "expectations": "Automated daily keep-alive submission. Timestamp: $TIMESTAMP",
            "submittedAt": "$DATE_ISO"
          }
          EOF
          
          echo "Sending POST request to $BACKEND_BASE/submit-form"
          echo "Payload:"
          cat dummy_data.json
          
          # Send the POST request
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$BACKEND_BASE/submit-form" \
            -H "Content-Type: application/json" \
            -d @dummy_data.json)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response HTTP Code: $HTTP_CODE"
          echo "Response Body: $RESPONSE_BODY"
          
          # Check if the request was successful
          if [[ $HTTP_CODE -ge 200 && $HTTP_CODE -lt 300 ]]; then
            echo "âœ… Keep-alive submission successful!"
            exit 0
          else
            echo "âŒ Keep-alive submission failed with HTTP $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi
