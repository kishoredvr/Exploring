name: Keep Alive - Daily Form Submission
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y curl jq openssl
        
      - name: Generate test data
        run: |
          TIMESTAMP=$(date +%s)
          RANDOM_ID=$(openssl rand -hex 4)
          DATE_ISO=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          
          # Create payload
          cat > payload.json << EOF
          {
            "purpose": "Other",
            "name": "Test User $RANDOM_ID",
            "email": "test.$RANDOM_ID@example.com",
            "mobileNumber": "98765${RANDOM_ID:0:4}",
            "astro_service_tier": "not applicable",
            "payment_amount": "0",
            "payment_status": "not applicable",
            "contactCountry": "Test Country",
            "expectations": "Daily keep-alive test submission. Timestamp: $TIMESTAMP",
            "submittedAt": "$DATE_ISO"
          }
          EOF
          
          echo "Generated payload"
          cat payload.json
          
      - name: Send submission using curl
        env:
          BACKEND_URL: 'https://lkvcbpxkpwpoqjlcddgl.functions.supabase.co/submit-form'
        run: |
          echo "Sending submission to Supabase function..."
          
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X POST "$BACKEND_URL" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d @payload.json \
            --max-time 30)
            
          # Extract HTTP code
          HTTP_CODE=$(echo "$RESPONSE" | grep -o 'HTTP_CODE:[0-9]*' | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Success"
            exit 0
          else
            echo "⚠️ Non-success response"
            exit 0  # Don't fail workflow
          fi
          
      - name: Health check
        if: always()
        run: |
          echo "Health check..."
          curl -s -o /dev/null -w "Main URL: %{http_code}\n" \
            "https://lkvcbpxkpwpoqjlcddgl.functions.supabase.co" \
            --max-time 10 || echo "Health check failed"
