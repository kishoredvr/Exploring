name: Keep Supabase Alive

on:
  schedule:
    # Runs at minute 0 past hour 0, 10, and 20 (UTC) every day.
    - cron: "0 */10 * * *"
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest
    steps:
      - name: Send Keep-Alive Payload
        env:
          # We need the Anon Key to pass the Supabase Gateway security check.
          # If this is missing, the request triggers an "EarlyDrop" or 401 Unauthorized.
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          # 1. Generate Dynamic Variables
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          UNIQUE_ID="KEEPALIVE-$(date +%s)"

          # 2. Construct JSON Payload securely
          JSON_PAYLOAD=$(cat <<EOF
          {
            "name": "KeepAlive Bot",
            "email": "keepalive@system.bot",
            "mobileNumber": "9999999999",
            "purpose": "Other",
            "astroServiceSelect": "Not applicable",
            "astro_service_tier": "Not applicable",
            "birthDetailsAvailable": "Not applicable",
            "dob": "Not applicable",
            "hour": "Not applicable",
            "minute": "Not applicable",
            "second": "Not applicable",
            "explanation": "Not applicable",
            "city": "Not applicable",
            "state": "Not applicable",
            "country": "Not applicable",
            "pincode": "Not applicable",
            "gender": "Not applicable",
            "genderOtherInput": "Not applicable",
            "accuracy": "Not applicable",
            "contactCountry": "India",
            "expectations": "Automated keep-alive request for $TIMESTAMP",
            "phonepe_txn_id": "KA-TXN-0000",
            "phonepe_order_id": "$UNIQUE_ID",
            "payment_amount": "0",
            "payment_status": "not applicable",
            "submittedAt": "$TIMESTAMP"
          }
          EOF
          )

          echo "----------------------------------------"
          echo "Sending payload with ID: $UNIQUE_ID"
          echo "----------------------------------------"

          # 3. Send Request and Capture Response
          # Added --max-time 60 to prevent client disconnects during Cold Starts.
          # Added Authorization header to prevent Gateway Rejection (EarlyDrop).
          response=$(curl -s -w "\n%{http_code}" -X POST "https://lkvcbpxkpwpoqjlcddgl.functions.supabase.co/submit-form" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            --max-time 60 \
            -d "$JSON_PAYLOAD")

          # Split response into Body and HTTP Status Code
          http_body=$(echo "$response" | sed '$d')
          http_code=$(echo "$response" | tail -n1)

          echo "Server Response Body: $http_body"
          echo "HTTP Status Code: $http_code"

          # 4. Validate Success
          if [ "$http_code" -ne 200 ]; then
            echo "::error::Request failed with HTTP status $http_code"
            exit 1
          fi
