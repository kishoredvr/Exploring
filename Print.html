<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Print Consultation Details</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --bg:#fff; --accent:#0987b5; --muted:#666; --border:#ddd; --pad:12px; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#111; }
    body { background: #f4f7fb; margin:0; padding:24px; display:flex; justify-content:center; }
    .card { background:var(--bg); width:100%; max-width:920px; border-radius:10px; box-shadow:0 10px 30px rgba(16,24,40,0.06); padding:20px; }
    h1 { margin:0 0 10px 0; color:var(--accent); font-size:20px; }
    p.lead { margin:0 0 18px 0; color:var(--muted); font-size:14px; }
    .status { margin:10px 0 18px 0; color:#a94442; font-weight:600; }
    table { width:100%; border-collapse:collapse; margin-top:6px; }
    th, td { border:1px solid var(--border); padding:10px; text-align:left; vertical-align:top; }
    th { background: #fafafa; width:30%; font-weight:700; }
    .actions { display:flex; gap:10px; margin-top:18px; }
    button { background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    button.secondary { background:#e9eef3; color:#0b3a4a; }
    .muted { color:var(--muted); font-size:13px; margin-top:8px; }

    /* Print styles - hide buttons */
    @media print {
      .actions, .muted { display:none; }
      body { padding:0; background:#fff; }
      .card { box-shadow:none; border-radius:0; width:100%; padding:0; }
      th, td { font-size:12px; padding:8px; }
    }
  </style>
</head>
<body>
  <div class="card" id="card">
    <h1>Consultation â€” Printable Details</h1>
    <p class="lead">This page shows a short-lived printable view of your submission. Use <strong>Print</strong> to print or save as PDF.</p>

    <div id="statusMsg" class="status" style="display:none;"></div>

    <div id="tableWrap" style="display:none;">
      <div id="tableContainer"></div>
      <div class="actions" id="actions" style="display:none;">
        <button id="printBtn">Print</button>
        <button id="backBtn" class="secondary">Back</button>
      </div>
      <div class="muted">Token is short-lived and will expire automatically. The full record is stored in your email.</div>
    </div>

    <div id="errorWrap" style="display:none;">
      <p id="errorMsg" style="color:#b02a37; font-weight:600;"></p>
      <div style="margin-top:12px;">
        <button id="goBackBtn" class="secondary">Go back to MessageMe</button>
      </div>
    </div>
  </div>

<script>
/*
  print.html
  - Reads `tok` query parameter (JWT)
  - Decodes payload (no cryptographic verification in browser)
  - Checks exp field (if present) and warns if expired
  - Renders table of payload.data
  - Removes token from URL (history.replaceState) after successful decode
*/

function qs(name) {
  return new URLSearchParams(window.location.search).get(name);
}

// Base64-url decode (handle unicode)
function b64DecodeUnicode(str) {
  try {
    // atob works on base64; we map to percent-encoded UTF-8 and decode
    return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
  } catch (e) {
    // fallback: return raw atob content
    try { return atob(str); } catch (_) { return null; }
  }
}
function base64UrlDecode(str) {
  if (!str) return null;
  // replace URL-safe chars
  str = str.replace(/-/g, '+').replace(/_/g, '/');
  // pad with '='
  while (str.length % 4) str += '=';
  return b64DecodeUnicode(str);
}

function decodeJwtNoVerify(token) {
  if (!token || typeof token !== 'string') throw new Error('Missing token');
  const parts = token.split('.');
  if (parts.length < 2) throw new Error('Invalid token format');
  const payloadB64 = parts[1];
  const json = base64UrlDecode(payloadB64);
  if (!json) throw new Error('Failed to decode token payload');
  return JSON.parse(json);
}

function renderTable(data) {
  const container = document.getElementById('tableContainer');
  // Keep a preferred order if keys known
  const preferredOrder = [
    "merchantOrderId","name","email","mobileNumber","purpose","astro_service_tier","astroServiceSelect",
    "dob","hour","minute","second","birthDetailsAvailable","city","state","country",
    "gender","genderOtherInput","accuracy","contactCountry","expectations",
    "phonepe_order_id","phonepe_txn_id","payment_amount","payment_status","submittedAt","note"
  ];
  const keys = Array.from(new Set([...preferredOrder, ...Object.keys(data)]));
  let html = '<table><tbody>';
  keys.forEach(k => {
    if (!(k in data)) return;
    const raw = data[k] === null || data[k] === undefined ? '' : String(data[k]);
    const safeKey = String(k).replace(/</g,'&lt;');
    const safeVal = raw.replace(/</g,'&lt;').replace(/\n/g,'<br/>');
    html += `<tr><th>${safeKey}</th><td>${safeVal}</td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

async function init() {
  const tok = qs('tok');
  const statusMsg = document.getElementById('statusMsg');
  const tableWrap = document.getElementById('tableWrap');
  const errorWrap = document.getElementById('errorWrap');
  const actions = document.getElementById('actions');
  try {
    if (!tok) throw new Error('No token provided in URL.');
    // decode
    const payload = decodeJwtNoVerify(tok);
    // payload expected shape: { iss, aud, data: {...}, exp: <numeric> }
    if (!payload || typeof payload !== 'object') throw new Error('Invalid token payload.');
    const data = payload.data || payload; // if someone stored raw
    // check expiry if present
    const nowSec = Math.floor(Date.now() / 1000);
    if (payload.exp && typeof payload.exp === 'number') {
      if (nowSec > payload.exp) {
        throw new Error('The printable token has expired.');
      }
    }
    // render
    renderTable(data);
    // show UI
    tableWrap.style.display = 'block';
    actions.style.display = 'flex';
    // remove token from URL to avoid leaking in history/refs
    try {
      const newUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, newUrl);
    } catch (e) { /* ignore */ }

    // hook buttons
    document.getElementById('printBtn').addEventListener('click', () => {
      window.print();
    });
    document.getElementById('backBtn').addEventListener('click', () => {
      // go back to message page
      window.location.href = '/MessageMe.html';
    });

  } catch (err) {
    // show error
    errorWrap.style.display = 'block';
    document.getElementById('errorMsg').textContent = err.message || 'Invalid token or expired.';
    // hide table area
    tableWrap.style.display = 'none';
    // back button
    document.getElementById('goBackBtn').addEventListener('click', () => {
      window.location.href = '/MessageMe.html';
    });
  }
}

init();
</script>
</body>
</html>
