<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Print Consultation Data</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding:20px; color:#222; }
    .table-wrap { max-width:900px; margin:10px auto; }
    table { border-collapse: collapse; width:100%; }
    td,th { padding:10px; border:1px solid #ddd; text-align:left; }
    .actions { text-align:center; margin:18px 0; }
    button { padding:10px 18px; font-size:16px; }
  </style>
</head>
<body>
  <div class="table-wrap">
    <h2>Consultation Details</h2>
    <div id="status">Loading...</div>
    <div id="tableContainer" style="display:none;"></div>
    <div class="actions" id="actions" style="display:none;">
      <button id="printBtn">Print</button>
      <button id="closeBtn" onclick="window.close()">Close</button>
    </div>
  </div>

<script>
  const BACKEND_BASE = 'https://lkvcbpxkpwpoqjlcddgl.functions.supabase.co'; // keep same backend base
  function qs(name) {
    return new URLSearchParams(window.location.search).get(name);
  }
  const tok = qs('tok');
  async function render() {
    const statusEl = document.getElementById('status');
    const tableContainer = document.getElementById('tableContainer');
    const actions = document.getElementById('actions');
    if (!tok) {
      statusEl.textContent = 'No token provided.';
      return;
    }
    statusEl.textContent = 'Verifying token...';
    try {
      const resp = await fetch(`${BACKEND_BASE}/render-token?tok=${encodeURIComponent(tok)}`, { method: 'GET' });
      const j = await resp.json();
      if (!j.success) {
        statusEl.textContent = 'Unable to verify token: ' + (j.error || 'unknown');
        return;
      }
      statusEl.style.display = 'none';
      const data = j.data || {};
      // build table
      let html = '<table><tbody>';
      for (const k of Object.keys(data)) {
        const safeK = k.replace(/</g,'&lt;');
        const safeV = (data[k] === null || data[k] === undefined) ? '' : String(data[k]).replace(/</g,'&lt;').replace(/\n/g,'<br/>');
        html += `<tr><th>${safeK}</th><td>${safeV}</td></tr>`;
      }
      html += '</tbody></table>';
      tableContainer.innerHTML = html;
      tableContainer.style.display = 'block';
      actions.style.display = 'block';

      document.getElementById('printBtn').addEventListener('click', () => {
        window.print();
      });
    } catch (err) {
      statusEl.textContent = 'Error fetching print data: ' + String(err);
    }
  }
  render();
</script>
</body>
</html>
