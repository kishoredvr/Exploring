<!DOCTYPE html>  
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Let's Connect</title>

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Open+Sans:wght@400;500;600;700&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
    html, body { height: 100%; }
    body { font-family: 'Lora', serif; background: linear-gradient(to bottom, rgba(220, 220, 220, 0.95), rgba(245, 245, 245, 0.95)), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="%230987b5" opacity="0.05"/></svg>'); background-size: 150px; color: #333; line-height: 1.6; padding: 20px; min-height: 100vh; }
    nav { background: linear-gradient(135deg, #0987b5, #076a91); padding: 6px 3%; display: flex; justify-content: center; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1); position: sticky; top: 0; margin-left:0px;margin-right:0px; z-index: 100; }
    .nav-links { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 1600px; width: 100%; }
    nav a { padding: 5px 11px; color: #e8f4ff; text-decoration: none; font-family: 'Open Sans', sans-serif; font-weight: 600; font-size: 0.95rem; border-radius: 30px; transition: all 0.25s ease; border: 1px solid rgba(255, 255, 255, 0.12); text-align: center; background: rgba(255, 255, 255, 0.06); transform: scale(0.8); }
    nav a:hover { background-color: white; color: #0987b5; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
    nav a.active { background-color: rgba(255, 255, 255, 0.28); border-color: rgba(255, 255, 255, 0.4); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12); }
    .container { max-width: 1000px; margin: 20px auto; background: linear-gradient(to bottom, #ffffff, #fbfeff); padding: 32px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.08); }
    .header { text-align: center; margin-bottom: 12px; }
    .header h1 { color: #076a91; margin-bottom: 8px; font-size: 30px; font-family: 'Open Sans', sans-serif; }
    .header p { color: #5a9ec9; font-size: 16px; }
    .form-section { margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .form-section h2 { color: #076a91; margin-bottom: 10px; font-size: 20px; display: flex; align-items: center; font-family: 'Open Sans', sans-serif; }
    .form-section h2::before { content: "âœ¦"; margin-right: 10px; font-size: 20px; color: rgba(9,135,181,0.9); }
    .form-group { margin-bottom: 10px; }
    label { display: block; margin-bottom: 4px; font-weight: 600; color: #2c3e50; font-family: 'Open Sans', sans-serif; }
    .required::after { content: " *"; color: #e74c3c; }
    input, select, textarea { width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; transition: all 0.2s; font-family: inherit; }
    input:focus, select:focus, textarea:focus { border-color: #0987b5; outline: none; box-shadow: 0 0 0 3px rgba(9,135,181,0.10); }
    .radio-group { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 4px; }
    .radio-option { display: flex; align-items: center; gap: 6px; font-family: 'Open Sans', sans-serif; color: #33475b; }
    .time-fields { display: flex; gap: 12px; }
    .time-fields .form-group { flex: 1; }
    .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
    button { padding: 12px 20px; background: linear-gradient(90deg,#0987b5,#5ac3f0); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 6px 18px rgba(9,135,181,0.18); }
    button:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(9,135,181,0.20); }
    .success-message { background-color: #d4edda; color: #155724; padding: 12px; border-radius: 8px; margin-bottom: 14px; display: none; text-align: center; }
    .error-message { background-color: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-bottom: 14px; display: none; text-align: center; }
    .word-count { text-align: right; font-size: 13px; color: #7f8c8d; margin-top: 6px; }
    .disabled-section { opacity: 0.6; pointer-events: none; }
    .disabled-field { background-color: #f0f0f0; cursor: not-allowed; color: #7f8c8d; }
    .centered-section { max-width: 760px; margin-left: auto; margin-right: auto; }
    .action-buttons { display: flex; justify-content: center; gap: 16px; margin-top: 18px; }
    .hide { display: none; }
    input[type="number"].time-input { width: 100%; padding: 8px; }
    .consultation-note { background-color: #f8f9fa; border-left: 4px solid #0987b5; padding: 12px 16px; margin: 12px 0; border-radius: 4px; font-size: 14px; color: #2c3e50; display: none; }
    
    /* Validation error styles */
    .validation-error { border-color: #e74c3c !important; }
    .validation-message { color: #e74c3c; font-size: 13px; margin-top: 4px; display: none; }
    
    /* Sample report link styles */
    .sample-report-link { 
      margin-top: 8px; 
      text-align: center; 
      padding: 8px; 
      background: #f8f9fa; 
      border-radius: 6px; 
      border: 1px dashed #0987b5;
    }
    .sample-report-link a {
      color: #0987b5;
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .sample-report-link a:hover {
      color: #076a91;
      text-decoration: underline;
    }
    
    /* Payment processing modal */
    .payment-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    .payment-modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      text-align: center;
    }
    .payment-modal h3 {
      color: #076a91;
      margin-bottom: 15px;
    }
    .payment-modal p {
      margin-bottom: 20px;
      color: #555;
    }
    .payment-processing {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    .payment-processing .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #0987b5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Mobile-specific optimizations */
    @media (max-width: 900px) { 
      .two-column { grid-template-columns: 1fr; } 
      .centered-section { max-width: 100%; padding: 0 8px; } 
      .time-fields { flex-direction: row; gap: 10px; } 
      button { width: 48%; } 
    }
    
    @media (max-width: 768px) {
      body { padding: 10px; }
      .container { padding: 20px; border-radius: 16px; margin: 10px auto; }
      .header h1 { font-size: 24px; }
      .header p { font-size: 14px; }
      .form-section h2 { font-size: 18px; }
      .form-section h2::before { font-size: 18px; margin-right: 8px; }
      input, select, textarea { font-size: 16px; /* Prevents zoom on iOS */ }
      button { font-size: 16px; }
      .action-buttons { flex-direction: column; gap: 12px; }
      button { width: 100%; }
      .nav-links { gap: 8px; }
      nav a { font-size: 0.85rem; padding: 4px 8px; }
      .radio-group { gap: 8px; }
      .radio-option { font-size: 14px; }
    }
    
    @media (max-width: 480px) {
      body { padding: 5px; }
      .container { padding: 16px; border-radius: 12px; }
      .header h1 { font-size: 22px; }
      .header p { font-size: 13px; }
      .form-section h2 { font-size: 16px; }
      .form-section h2::before { font-size: 16px; margin-right: 6px; }
      .time-fields { flex-direction: column; gap: 8px; }
      .time-fields .form-group { flex: none; }
      .time-fields .form-group label { margin-left: 0 !important; }
      .time-fields .form-group input { width: 100% !important; margin-left: 0 !important; }
      .two-column .form-section { margin-left: 0 !important; }
      .two-column .form-group { margin-left: 0 !important; }
      #birth-details-section { margin-left: 0 !important; }
      .payment-modal-content { padding: 20px; }
      .payment-modal h3 { font-size: 18px; }
      .payment-modal p { font-size: 14px; }
      .sample-report-link { padding: 6px; font-size: 14px; }
    }
    
    @media (max-width: 360px) {
      .container { padding: 12px; }
      .header h1 { font-size: 20px; }
      .header p { font-size: 12px; }
      .form-section h2 { font-size: 15px; }
      .radio-group { flex-direction: column; gap: 6px; }
      .radio-option { font-size: 13px; }
      nav a { font-size: 0.8rem; padding: 3px 6px; }
    }
    
    /* Print styles */
    @page { size: A4; margin: 10mm; }
    @media print { 
      html, body { background: white !important; color: #000 !important; width: 100% !important; height: auto !important; overflow: visible !important; padding: 0 !important; margin: 0 !important; font-size: 12px !important; } 
      .container { box-shadow: none !important; border-radius: 0 !important; max-width: 100% !important; width: 100% !important; margin: 0 !important; padding: 5mm !important; background: white !important; page-break-inside: avoid; } 
      .header h1 { font-size: 20px !important; margin-bottom: 4px !important; } 
      .header p { font-size: 12px !important; color: #333 !important; margin-bottom: 8px !important; } 
      .form-section { margin-bottom: 8px !important; padding-bottom: 6px !important; page-break-inside: avoid; } 
      .form-group { margin-bottom: 6px !important; } 
      .two-column { grid-template-columns: 1fr 1fr !important; gap: 10px !important; page-break-inside: avoid; } 
      .time-fields { display: flex !important; gap: 2px !important; width: 60% !important; } 
      .time-fields .form-group { flex: 1 !important; margin-bottom: 0 !important; } 
      input[type="number"].time-input { width: 80% !important; padding: 4px !important; font-size: 12px !important; } 
      [style*="margin-left"] { margin-left: 0 !important; } 
      [style*="width:160%"], [style*="width:120%"] { width: 100% !important; } 
      input, select, textarea { width: 100% !important; border: 1px solid #999 !important; box-shadow: none !important; background: transparent !important; color: #000 !important; padding: 4px 6px !important; font-size: 12px !important; page-break-inside: avoid; } 
      textarea { max-width: 100% !important; min-height: 50px !important; } 
      button, .action-buttons { display: none !important; } 
      .success-message, .error-message { display: none !important; } 
      .consultation-note { display: block !important; background-color: transparent !important; border-left: 2px solid #0987b5 !important; padding: 6px 8px !important; margin: 8px 0 !important; font-size: 11px !important; color: #000 !important; page-break-inside: avoid; } 
      .radio-group { gap: 8px !important; flex-wrap: nowrap !important; } 
      .radio-option { white-space: nowrap !important; font-size: 12px !important; } 
      #birth-details-section { margin-left: 0 !important; } 
      .form-section h2 { font-size: 16px !important; margin-bottom: 6px !important; } 
      label { font-size: 12px !important; margin-bottom: 2px !important; } 
      input[type="date"] { width: 36% !important; } 
      .word-count { font-size: 10px !important; margin-top: 2px !important; } 
      .centered-section { max-width: 100% !important; padding: 0 !important; } 
      #gender-other-input-wrapper { margin-left: 0 !important; } 
      .form-section, .two-column, .time-fields { page-break-inside: avoid; } 
    }
  </style>
</head>
<body>
  <nav>
    <div class="nav-links">
      <a href="https://kishoredvr.github.io/Exploring/">Home</a>
      <a href="https://kishoredvr.github.io/Exploring/AboutMe.html">Origin Of Thoughts</a>
      <a href="https://parishodana.xyz/Articles.html">My Articles</a>
      <a href="https://kishoredvr.github.io/Exploring/MessageMe.html" class="active">Let's Connect</a>
    </div>
  </nav>

  <div class="container">
    <div class="header">
      <h1>Let's Connect</h1>
      <p>Your detailed and thoughtful information will help us give you the best possible response</p>
    </div>

    <div id="successMessage" class="success-message">Thank you! Your consultation request has been submitted successfully.</div>
    <div id="errorMessage" class="error-message">There was an error submitting your request. Please try again.</div>

    <form id="astrology-consultation-form" novalidate>
      <div class="form-section always-enabled centered-section" style="text-align: center;">
        <div style="display:flex;align-items:center;justify-content:center;gap:18px;flex-wrap:wrap;">
          <h2 style="margin:0;">Purpose</h2>
          <div class="radio-group" aria-label="Purpose">
            <label class="radio-option"><input type="radio" id="purpose-astrology" name="purpose" value="Astrology" required checked> Astrology Consultation</label>
            <label class="radio-option"><input type="radio" id="purpose-other" name="purpose" value="Other"> Other Purpose</label>
          </div>
        </div>

        <div id="consultationNote" class="consultation-note">
          <strong>Note:</strong> Select a service tier below and pay the applicable fee.
        </div>

        <div id="astroServiceWrapper" class="form-group centered-section" style="max-width:380px; margin: 12px auto 0; display:none;">
          <label for="astroServiceSelect">Choose Astrology Service</label>
          <select id="astroServiceSelect" name="astroServiceSelect">
            <option value="1000">Basic â€” â‚¹1000</option>
            <option value="2000">Detailed â€” â‚¹2000</option>
            <option value="5000">Premium â€” â‚¹5000</option>
          </select>
        </div>

        <!-- Sample Report Link -->
        <div id="sampleReportWrapper" class="sample-report-link" style="display: none;">
          <a href="#" id="sampleReportLink" target="_blank">
            <i class="fas fa-external-link-alt"></i>
            View Sample Report for <span id="serviceTierName">Basic</span> Service
          </a>
        </div>
      </div>

      <div class="form-section centered-section">
        <h2>Contact Information</h2>
        <div class="two-column">
          <div class="form-group">
            <label for="name" class="required">Full Name</label>
            <input type="text" id="name" name="name" required>
            <div class="validation-message" id="name-error">Please enter your full name</div>
          </div>

          <div class="form-group">
            <label for="email" class="required">Email Address</label>
            <input type="email" id="email" name="email" required>
            <div class="validation-message" id="email-error">Please enter a valid email address</div>
          </div>
        </div>
        
        <!-- Added mobile number field for PhonePe payment -->
        <div class="form-group">
          <label for="mobileNumber" class="required">Mobile Number (for Payment)</label>
          <input type="tel" id="mobileNumber" name="mobileNumber" required>
          <div class="validation-message" id="mobileNumber-error">Please enter a valid mobile number</div>
        </div>
      </div>

      <div class="two-column">
        <div>
          <div class="form-section" id="birth-details-section" style="margin-left:90px;">
            <h2>Birth Details</h2>
            <div class="form-group">
              <label for="birthDetailsAvailable" class="required">Are your birth details available?</label>
              <div class="radio-group" id="birthDetailsAvailable-group">
                <label class="radio-option"><input type="radio" id="birth-yes" name="birthDetailsAvailable" value="Yes" required> Yes</label>
                <label class="radio-option"><input type="radio" id="birth-no" name="birthDetailsAvailable" value="No"> No</label>
              </div>
              <div class="validation-message" id="birthDetailsAvailable-error">Please select if birth details are available</div>
            </div>

            <div class="form-group">
              <label for="dob">Date of Birth</label>
              <input type="date" id="dob" name="dob" style="width:40%;">
            </div>

            <div class="form-group">
              <label for="tob" style="margin-bottom:-2px;">Time of Birth</label>
              <div class="time-fields">
                <div class="form-group">
                  <label for="hour" style="margin-left:8px;">Hrs</label>
                  <input type="number" id="hour" name="hour" min="0" max="23" placeholder="HH" class="time-input" style="width:50%;">
                </div>
                <div class="form-group">
                  <label for="minute" style="margin-left:-60px;">Mins</label>
                  <input type="number" id="minute" name="minute" min="0" max="59" placeholder="MM" class="time-input" style="width:50%;margin-left:-60px;">
                </div>
                <div class="form-group">
                  <label for="second" style="margin-left:-120px;">Secs</label>
                  <input type="number" id="second" name="second" min="0" max="59" placeholder="SS" class="time-input" style="width:50%;margin-left:-120px;">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="explanation" id="explanation-label" style="display:none;">Please explain why the details might not be accurate</label>
              <textarea id="explanation" name="explanation" rows="3" style="display:none;" placeholder="Please provide explanation here..."></textarea>
            </div>
          </div>
        </div>

        <div>
          <div class="form-section" id="birth-location-section">
            <h2>Birth Location</h2>
            <div class="form-group">
              <label for="city" class="required">City/Village</label>
              <input type="text" id="city" name="city" required>
              <div class="validation-message" id="city-error">Please enter your city/village</div>
            </div>
            <div class="form-group">
              <label for="state" class="required">State/Province</label>
              <input type="text" id="state" name="state" required>
              <div class="validation-message" id="state-error">Please enter your state/province</div>
            </div>
            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div><br>
                <label for="country" class="required">Country</label>
                <input type="text" id="country" name="country" required>
                <div class="validation-message" id="country-error">Please enter your country</div>
              </div>
              <div><br>
                <label for="pincode" class="required">Pincode</label>
                <input type="text" id="pincode" name="pincode" required>
                <div class="validation-message" id="pincode-error">Please enter your pincode</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="two-column">
        <div>
          <div class="form-group" style="margin-left:90px;">
            <label for="gender" class="required">Gender</label>
            <div class="radio-group" role="radiogroup" aria-labelledby="gender" id="gender-group">
              <label class="radio-option"><input type="radio" id="gender-male" name="gender" value="Male" required> Male</label>
              <label class="radio-option"><input type="radio" id="gender-female" name="gender" value="Female"> Female</label>
              <label class="radio-option"><input type="radio" id="gender-other" name="gender" value="Other"> Other</label>
            </div>
            <div class="validation-message" id="gender-error">Please select your gender</div>

            <div id="gender-other-input-wrapper" class="form-group hide" style="margin-top:4px;">
              <label for="genderOtherInput">Please explain for better understanding</label>
              <input type="text" id="genderOtherInput" name="genderOtherInput" placeholder="Explanation">
              <div class="validation-message" id="genderOtherInput-error">Please provide explanation for gender</div>
            </div>
          </div>
        </div>

        <div>
          <div class="form-group" id="accuracy-section">
            <label for="accuracy" class="required">Are the birth details provided accurate?</label>
            <div class="radio-group" id="accuracy-group">
              <label class="radio-option"><input type="radio" id="accuracy-yes" name="accuracy" value="Yes" required> Yes</label>
              <label class="radio-option"><input type="radio" id="accuracy-no" name="accuracy" value="No"> No</label>
            </div>
            <div class="validation-message" id="accuracy-error">Please select if birth details are accurate</div>
          </div>
        </div>
      </div>

      <div class="form-section always-enabled centered-section" style="margin-top: 12px;">
        <div class="form-group" id="country-field">
          <label for="contactCountry" class="required">Which country you belong to?</label>
          <input type="text" id="contactCountry" name="contactCountry" required>
          <div class="validation-message" id="contactCountry-error">Please enter your country</div>
        </div>
      </div>

      <div class="form-section always-enabled centered-section" style="margin-top: 12px;">
        <h2>Let me know your intentions for contacting me</h2>
        <div class="form-group">
          <textarea id="expectations" name="expectations" rows="6" required placeholder="Please describe your intentions and expectations in detail..."></textarea>
          <div class="validation-message" id="expectations-error">Please describe your intentions and expectations</div>
          <div class="word-count">Maximum 5000 words: <span id="wordCount">0</span>/5000</div>
        </div>
      </div>

      <div id="termsWrapper" class="form-section centered-section" style="display:none; margin-top:8px;">
        <div class="form-group" style="display:flex;align-items:center;gap:10px;">
          <input type="checkbox" id="termsAgree" name="termsAgree" style="width:5%;"/>
          <label for="termsAgree" style="font-weight:600;">I agree to the <a href="https://parishodana.xyz/Terms.html" id="termsLink" target="_blank" rel="noopener noreferrer">Terms and Conditions</a>.</label>
        </div>
        <div class="validation-message" id="termsAgree-error">Please agree to the terms and conditions</div>
      </div>

      <div class="action-buttons">
        <button id="clearButton" type="button" style="background:#ccc;color:#222;">Clear All</button>
        <button id="submitBtn" type="submit">Submit Consultation Request</button>
      </div>

      <!-- Hidden fields for PhonePe payment result (server will verify) -->
      <input type="hidden" name="phonepe_txn_id" id="phonepe_txn_id" />
      <input type="hidden" name="phonepe_order_id" id="phonepe_order_id" />
      <input type="hidden" name="payment_amount" id="payment_amount" />
      <input type="hidden" name="payment_status" id="payment_status" />
      <input type="hidden" name="astro_service_tier" id="astro_service_tier" />
    </form>
  </div>

  <!-- Payment Processing Modal -->
  <div class="payment-modal" id="paymentModal">
    <div class="payment-modal-content">
      <h3>Processing Payment</h3>
      <p>Please wait while we redirect you to PhonePe for secure payment processing.</p>
      <div class="payment-processing">
        <div class="spinner"></div>
      </div>
      <p>Do not refresh or close this window.</p>
    </div>
  </div>

  <script>
    // Set this to your Supabase Functions base URL (or other server that exposes these endpoints).
    // Example: const BACKEND_BASE = 'https://lkvcbpxkpwpoqjlcddgl.functions.supabase.co';
    const BACKEND_BASE = 'https://lkvcbpxkpwpoqjlcddgl.functions.supabase.co'; // <-- replace with your functions domain

    // All client code uses BACKEND_BASE now
    const form = document.getElementById('astrology-consultation-form');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const paymentModal = document.getElementById('paymentModal');

    const accuracyYes = document.getElementById('accuracy-yes');
    const accuracyNo = document.getElementById('accuracy-no');
    const explanation = document.getElementById('explanation');
    const explanationLabel = document.getElementById('explanation-label');

    const expectations = document.getElementById('expectations');
    const wordCount = document.getElementById('wordCount');

    const purposeAstrology = document.getElementById('purpose-astrology');
    const purposeOther = document.getElementById('purpose-other');
    const consultationNote = document.getElementById('consultationNote');

    const birthDetailsSection = document.getElementById('birth-details-section');
    const birthLocationSection = document.getElementById('birth-location-section');
    const contactCountryField = document.getElementById('contactCountry');
    const accuracySection = document.getElementById('accuracy-section');
    const clearButton = document.getElementById('clearButton');

    const genderMale = document.getElementById('gender-male');
    const genderFemale = document.getElementById('gender-female');
    const genderOther = document.getElementById('gender-other');
    const genderOtherInputWrapper = document.getElementById('gender-other-input-wrapper');
    const genderOtherInput = document.getElementById('genderOtherInput');

    const astroServiceWrapper = document.getElementById('astroServiceWrapper');
    const astroServiceSelect = document.getElementById('astroServiceSelect');
    const astroServiceTierHidden = document.getElementById('astro_service_tier');

    const termsWrapper = document.getElementById('termsWrapper');
    const termsAgree = document.getElementById('termsAgree');

    // New elements for sample report
    const sampleReportWrapper = document.getElementById('sampleReportWrapper');
    const sampleReportLink = document.getElementById('sampleReportLink');
    const serviceTierName = document.getElementById('serviceTierName');

    // Sample report URLs
    const sampleReportUrls = {
      '1000': 'https://drive.google.com/file/d/1jtcfBBXh1LmH6l6qWNw00c22H65EUiNM/view?usp=sharing', // Basic
      '2000': 'https://drive.google.com/file/d/1dxJDr1eIaGapTzJBMoebfIi1yWw77A5D/view?usp=sharing', // Detailed
      '5000': 'https://drive.google.com/file/d/10KgT13w9mr5eNy23FHjbmUCFb_QRJW05/view?usp=sharing'  // Premium
    };

    // Service tier names
    const serviceTierNames = {
      '1000': 'Basic',
      '2000': 'Detailed', 
      '5000': 'Premium'
    };

    // Function to show validation error
    function showError(fieldId, message) {
      const field = document.getElementById(fieldId);
      const errorElement = document.getElementById(`${fieldId}-error`);
      
      if (field) {
        field.classList.add('validation-error');
      }
      
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
    }

    // Function to clear validation error
    function clearError(fieldId) {
      const field = document.getElementById(fieldId);
      const errorElement = document.getElementById(`${fieldId}-error`);
      
      if (field) {
        field.classList.remove('validation-error');
      }
      
      if (errorElement) {
        errorElement.style.display = 'none';
      }
    }

    // Function to validate email format
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    // Function to validate mobile number
    function validateMobile(mobile) {
      const re = /^[0-9]{10}$/;
      return re.test(mobile);
    }

    // Function to validate required radio groups
    function validateRadioGroup(groupName) {
      const selected = document.querySelector(`input[name="${groupName}"]:checked`);
      return selected !== null;
    }

    // Get the current purpose
    function getCurrentPurpose() {
      return document.querySelector('input[name="purpose"]:checked')?.value || 'Astrology';
    }

    // Main form validation function
    function validateForm() {
      let isValid = true;
      const purpose = getCurrentPurpose();

      // Clear all previous errors
      document.querySelectorAll('.validation-error').forEach(el => {
        el.classList.remove('validation-error');
      });
      document.querySelectorAll('.validation-message').forEach(el => {
        el.style.display = 'none';
      });

      // COMMON FIELDS (required for both purposes)
      const name = document.getElementById('name').value.trim();
      if (!name) {
        showError('name', 'Please enter your full name');
        isValid = false;
      }

      const email = document.getElementById('email').value.trim();
      if (!email) {
        showError('email', 'Please enter your email address');
        isValid = false;
      } else if (!validateEmail(email)) {
        showError('email', 'Please enter a valid email address');
        isValid = false;
      }

      const mobileNumber = document.getElementById('mobileNumber').value.trim();
      if (!mobileNumber) {
        showError('mobileNumber', 'Please enter your mobile number');
        isValid = false;
      } else if (!validateMobile(mobileNumber)) {
        showError('mobileNumber', 'Please enter a valid 10-digit mobile number');
        isValid = false;
      }

      const contactCountry = document.getElementById('contactCountry').value.trim();
      if (!contactCountry) {
        showError('contactCountry', 'Please enter your country');
        isValid = false;
      }

      const expectationsText = document.getElementById('expectations').value.trim();
      if (!expectationsText) {
        showError('expectations', 'Please describe your intentions and expectations');
        isValid = false;
      }

      // CONDITIONAL VALIDATION BASED ON PURPOSE
      if (purpose === 'Astrology') {
        // ASTROLOGY-SPECIFIC VALIDATION
        
        // Birth details available
        if (!validateRadioGroup('birthDetailsAvailable')) {
          showError('birthDetailsAvailable', 'Please select if birth details are available');
          isValid = false;
        }

        // Birth location fields
        const city = document.getElementById('city').value.trim();
        if (!city) {
          showError('city', 'Please enter your city/village');
          isValid = false;
        }

        const state = document.getElementById('state').value.trim();
        if (!state) {
          showError('state', 'Please enter your state/province');
          isValid = false;
        }

        const country = document.getElementById('country').value.trim();
        if (!country) {
          showError('country', 'Please enter your country');
          isValid = false;
        }

        const pincode = document.getElementById('pincode').value.trim();
        if (!pincode) {
          showError('pincode', 'Please enter your pincode');
          isValid = false;
        }

        // Gender
        if (!validateRadioGroup('gender')) {
          showError('gender', 'Please select your gender');
          isValid = false;
        }

        // If gender is "Other", validate the explanation field
        if (genderOther.checked && (!genderOtherInput.value || genderOtherInput.value.trim() === '')) {
          showError('genderOtherInput', 'Please provide explanation for gender');
          isValid = false;
        }

        // Accuracy
        if (!validateRadioGroup('accuracy')) {
          showError('accuracy', 'Please select if birth details are accurate');
          isValid = false;
        }

        // Terms and conditions
        if (!termsAgree.checked) {
          showError('termsAgree', 'Please agree to the terms and conditions');
          isValid = false;
        }
      } else {
        // OTHER PURPOSE VALIDATION
        // For "Other Purpose", only the common fields are required
        // Birth details, location, gender, accuracy, and terms are NOT required
      }

      return isValid;
    }

    // Add event listeners to clear errors when user starts typing
    document.querySelectorAll('input, textarea, select').forEach(field => {
      field.addEventListener('input', () => {
        clearError(field.id);
      });
    });

    // Add event listeners for radio buttons
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.addEventListener('change', () => {
        clearError(radio.name);
      });
    });

    // Add event listener for checkbox
    if (termsAgree) {
      termsAgree.addEventListener('change', () => {
        clearError('termsAgree');
      });
    }

    function updateSampleReportLink() {
      const selectedValue = astroServiceSelect.value;
      const url = sampleReportUrls[selectedValue];
      const tierName = serviceTierNames[selectedValue];
      
      if (url && tierName) {
        sampleReportLink.href = url;
        serviceTierName.textContent = tierName;
        sampleReportWrapper.style.display = 'block';
      } else {
        sampleReportWrapper.style.display = 'none';
      }
    }

    function toggleSections() {
      const purpose = getCurrentPurpose();
      
      if (purpose === 'Other') {
        birthDetailsSection.classList.add('disabled-section');
        birthLocationSection.classList.add('disabled-section');
        accuracySection.classList.add('disabled-section');
        consultationNote.style.display = 'none';
        sampleReportWrapper.style.display = 'none';

        document.querySelectorAll('#birth-details-section input, #birth-details-section select, #birth-location-section input').forEach(field => {
          field.removeAttribute('required');
        });

        document.querySelectorAll('#accuracy-section input').forEach(field => {
          field.removeAttribute('required');
          field.setAttribute('disabled', 'true');
        });

        explanation.style.display = 'none';
        explanationLabel.style.display = 'none';
        explanation.removeAttribute('required');

        contactCountryField.classList.remove('disabled-field');
        contactCountryField.removeAttribute('disabled');
        contactCountryField.setAttribute('required', 'true');

        astroServiceWrapper.style.display = 'none';
        astroServiceTierHidden.value = '';

        if (termsWrapper) {
          termsWrapper.style.display = 'none';
          termsAgree.checked = false;
          termsAgree.removeAttribute('required');
        }
      } else {
        birthDetailsSection.classList.remove('disabled-section');
        birthLocationSection.classList.remove('disabled-section');
        accuracySection.classList.remove('disabled-section');
        consultationNote.style.display = 'block';

        document.querySelectorAll('#birth-details-section [name="birthDetailsAvailable"]').forEach(field => {
          field.setAttribute('required', 'true');
        });
        document.querySelectorAll('#birth-location-section [required]').forEach(field => {
          field.setAttribute('required', 'true');
        });

        document.querySelectorAll('#accuracy-section input').forEach(field => {
          field.removeAttribute('disabled');
          field.setAttribute('required', 'true');
        });

        contactCountryField.classList.add('disabled-field');
        contactCountryField.setAttribute('disabled', 'true');
        contactCountryField.removeAttribute('required');

        astroServiceWrapper.style.display = 'block';
        astroServiceTierHidden.value = astroServiceSelect.value;

        // Update sample report link when astrology is selected
        updateSampleReportLink();

        if (termsWrapper) {
          termsWrapper.style.display = 'block';
          termsAgree.setAttribute('required', 'true');
        }
      }
    }

    function handleAccuracyExplanation() {
      if (accuracyNo.checked) {
        explanation.style.display = 'block';
        explanationLabel.style.display = 'block';
        explanation.setAttribute('required', 'true');
      } else {
        explanation.style.display = 'none';
        explanationLabel.style.display = 'none';
        explanation.removeAttribute('required');
      }
    }

    function toggleGenderOtherInput() {
      if (genderOther.checked) {
        genderOtherInputWrapper.classList.remove('hide');
        genderOtherInput.setAttribute('required', 'true');
      } else {
        genderOtherInputWrapper.classList.add('hide');
        genderOtherInput.removeAttribute('required');
        genderOtherInput.value = '';
      }
    }

    // Initialize form state
    toggleSections();
    handleAccuracyExplanation();
    toggleGenderOtherInput();

    purposeAstrology.addEventListener('change', toggleSections);
    purposeOther.addEventListener('change', toggleSections);

    accuracyYes.addEventListener('change', handleAccuracyExplanation);
    accuracyNo.addEventListener('change', handleAccuracyExplanation);

    genderMale.addEventListener('change', toggleGenderOtherInput);
    genderFemale.addEventListener('change', toggleGenderOtherInput);
    genderOther.addEventListener('change', toggleGenderOtherInput);

    astroServiceSelect.addEventListener('change', () => {
      astroServiceTierHidden.value = astroServiceSelect.value;
      updateSampleReportLink();
    });

    expectations.addEventListener('input', () => {
      const text = expectations.value;
      const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
      wordCount.textContent = words;
      if (words > 5000) {
        wordCount.style.color = '#e74c3c';
        expectations.style.borderColor = '#e74c3c';
      } else {
        wordCount.style.color = '#7f8c8d';
        expectations.style.borderColor = '#ddd';
      }
    });

    clearButton.addEventListener('click', () => {
      form.reset();
      wordCount.textContent = '0';
      explanation.style.display = 'none';
      explanationLabel.style.display = 'none';
      explanation.removeAttribute('required');

      genderOtherInputWrapper.classList.add('hide');
      genderOtherInput.removeAttribute('required');
      genderOtherInput.value = '';

      if (termsAgree) {
        termsAgree.checked = false;
        termsAgree.removeAttribute('required');
      }

      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';

      // Clear all validation errors
      document.querySelectorAll('.validation-error').forEach(el => {
        el.classList.remove('validation-error');
      });
      document.querySelectorAll('.validation-message').forEach(el => {
        el.style.display = 'none';
      });

      toggleSections();
      handleAccuracyExplanation();
      toggleGenderOtherInput();

      window.scrollTo(0, 0);
    });

    function formDataFromForm() {
      return new FormData(form);
    }

    function getSelectedAstroAmount() {
      const purpose = getCurrentPurpose();
      if (purpose !== 'Astrology') return 0;

      const sel = document.getElementById('astroServiceSelect');
      if (!sel) return 1000;

      const opt = sel.options[sel.selectedIndex];
      if (!opt) return 1000;

      const raw = (opt.getAttribute('data-amt') ?? opt.value ?? '').toString().trim();
      const amt = parseFloat(raw.replace(/[^\d.-]/g, ''));
      const final = (isFinite(amt) && amt > 0) ? Math.round(amt) : 1000;
      console.log('getSelectedAstroAmount -> raw:', raw, 'parsed:', amt, 'final (rupees):', final);
      return final;
    }

    // ---------------- Backend helpers (now using BACKEND_BASE) ----------------

    // NEW FUNCTION: Save form data immediately before payment
    async function saveFormDataImmediately() {
        const formData = collectFormObject();
        formData.payment_status = 'pending'; // Mark as pending payment
        
        try {
            const response = await fetch(BACKEND_BASE + '/submit-form', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            return response.ok;
        } catch (error) {
            console.error('Failed to save form data:', error);
            return false;
        }
    }

    async function createPhonePePayment(amountINR) {
      if (!BACKEND_BASE || BACKEND_BASE.includes('your-backend-url')) {
        throw new Error('Please configure BACKEND_BASE with your backend URL.');
      }
      const amountPaise = Number(amountINR) * 100;
      const body = {
        amount: amountPaise,
        userId: document.getElementById('email').value,
        mobileNumber: document.getElementById('mobileNumber').value,
        redirectUrl: BACKEND_BASE + '/return-handler'
      };
      const url = BACKEND_BASE + '/initiate-payment';
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error('Payment initiation failed: ' + text);
      }
      const json = await res.json();
      if (!json || !json.success) {
        throw new Error('Payment initiation failed: ' + (json && (json.error || json.message) ? (json.error || json.message) : JSON.stringify(json)));
      }
      return json;
    }

    const checkPaymentStatus = async (transactionId) => {
      if (!BACKEND_BASE || BACKEND_BASE.includes('your-backend-url')) {
        throw new Error('Please configure BACKEND_BASE with your backend URL.');
      }
      const statusUrl = `${BACKEND_BASE}/payment-status?txn=${encodeURIComponent(transactionId)}`;
      const resp = await fetch(statusUrl, { method: 'GET' });
      if (!resp.ok) {
        const text = await resp.text();
        throw new Error('Status check failed: ' + text);
      }
      return resp.json();
    };

    async function checkPaymentStatusDetailed(transactionId) {
      if (!BACKEND_BASE || BACKEND_BASE.includes('your-backend-url')) {
        return { ok: false, error: 'BACKEND_BASE not configured' };
      }
      const statusUrl = `${BACKEND_BASE}/payment-status?txn=${encodeURIComponent(transactionId)}`;
      try {
        const resp = await fetch(statusUrl, { method: 'GET' });
        const txt = await resp.text().catch(() => "");
        let body = null;
        try { body = txt ? JSON.parse(txt) : null; } catch (e) { body = { raw: txt }; }
        return { ok: resp.ok, status: resp.status, body };
      } catch (err) {
        return { ok: false, error: String(err) };
      }
    }

    // ---------- NEW: robust redirect extractor ----------
    function extractCheckoutUrl(orderResp) {
      const r = orderResp?.data && typeof orderResp.data === 'object' ? orderResp.data : orderResp;
      return (
        r?.data?.instrumentResponse?.redirectInfo?.url ||
        r?.data?.redirectInfo?.url ||
        r?.data?.checkoutUrl ||
        r?.redirectInfo?.url ||
        r?.redirectUrl ||
        r?.data?.checkout?.redirectUrl ||
        null
      );
    }

    // ---------- NEW: robust transactionId extractor ----------
    function extractTxnId(r) {
      const d = r?.data || r;
      return (
        d?.transactionId ||
        d?.merchantTransactionId ||
        d?.phonepeResponse?.data?.transactionId ||
        d?.phonepeResponse?.data?.merchantTransactionId ||
        d?.data?.transactionId ||
        null
      );
    }

    // ---------------- collect & submit ----------------

    function collectFormObject() {
      const fields = [
        "name","email","mobileNumber",
        "purpose","astroServiceSelect","astro_service_tier",
        "birthDetailsAvailable","dob","hour","minute","second","explanation",
        "city","state","country","pincode",
        "gender","genderOtherInput",
        "accuracy",
        "contactCountry",
        "expectations",
        "phonepe_txn_id","phonepe_order_id","payment_amount","payment_status"
      ];

      const out = {};
      function readRadio(name) {
        const r = document.querySelector(`input[name="${name}"]:checked`);
        return r ? r.value : null;
      }

      try {
        if (astroServiceSelect && astroServiceSelect.value) {
          astroServiceTierHidden.value = astroServiceSelect.value;
        }
      } catch(e){}

      for (const idOrName of fields) {
        let el = document.getElementById(idOrName);
        if (!el) {
          const byName = document.getElementsByName(idOrName);
          if (byName && byName.length === 1) el = byName[0];
        }

        let val = null;
        if (el) {
          if (el.type === "radio") {
            val = readRadio(el.name || idOrName);
          } else {
            val = el.value;
          }
        } else {
          const rVal = readRadio(idOrName);
          if (rVal !== null) val = rVal;
        }

        if ((idOrName === "gender") && !val) {
          const g = readRadio("gender");
          if (g === "Other") {
            const other = document.getElementById("genderOtherInput");
            if (other && other.value) val = `Other: ${other.value}`;
            else val = "Other";
          }
        }

        if (val === null || val === undefined || String(val).trim() === "") {
          out[idOrName] = "Not applicable";
        } else {
          out[idOrName] = String(val).trim();
        }
      }

      out.submittedAt = new Date().toISOString();
      return out;
    }

    async function submitFormToServer(formObj) {
      if (!BACKEND_BASE || BACKEND_BASE.includes('your-backend-url')) {
        throw new Error('Please configure BACKEND_BASE with your backend URL.');
      }

      const url = BACKEND_BASE + '/submit-form';
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formObj)
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error('Submission failed: ' + text);
      }
      return res.json();
    }

    function openPhonePeCheckout(url, inNewTab = true) {
      if (!url) throw new Error('Invalid PhonePe checkout URL');
      paymentModal.style.display = 'flex';
      
      if (inNewTab) {
        window.open(url, '_blank');
      } else {
        window.location.href = url;
      }
      
      setTimeout(() => {
        paymentModal.style.display = 'none';
      }, 5000);
    }

    // ---------- NEW: Resume flow when user returns to this page ----------
    document.addEventListener('DOMContentLoaded', async () => {
      const txn = sessionStorage.getItem('pp_txn_id');
      const amt = sessionStorage.getItem('pp_amt');

      if (!txn) return;

      try { paymentModal.style.display = 'flex'; } catch (_) {}

      let attempts = 0, finalStatus = null;
      const maxAttempts = 8, pollIntervalMs = 2000;

      while (attempts < maxAttempts) {
        attempts++;
        try {
          const stResp = await checkPaymentStatusDetailed(txn);
          if (stResp.ok && stResp.body) {
            const payload = stResp.body.data || stResp.body || {};
            const state =
              payload?.status ||
              payload?.state ||
              payload?.data?.transaction?.state ||
              payload?.data?.state ||
              payload?.data?.transaction?.status ||
              payload?.transaction?.state ||
              null;
            const s = (state || '').toString().toLowerCase();

            if (['success','paid','completed','captured'].some(x => s.includes(x)) ||
                stResp.body.success === true || stResp.body.paid === true) {
              finalStatus = { outcome: 'success', payload: stResp.body };
              break;
            }
            if (['failed','error','declined'].some(x => s.includes(x))) {
              finalStatus = { outcome: 'failed', payload: stResp.body };
              break;
            }
          }
        } catch (_) {}
        await new Promise(r => setTimeout(r, pollIntervalMs));
      }

      sessionStorage.removeItem('pp_txn_id');
      sessionStorage.removeItem('pp_amt');

      try { paymentModal.style.display = 'none'; } catch (_) {}

      if (finalStatus?.outcome === 'success') {
        try {
          const extractedTxn =
            finalStatus.payload?.data?.phonepeResponse?.data?.transactionId ||
            finalStatus.payload?.data?.transactionId ||
            finalStatus.payload?.transactionId || txn;

          document.getElementById('phonepe_txn_id').value = extractedTxn || '';
        } catch (_) {}
        document.getElementById('phonepe_order_id').value = txn;
        document.getElementById('payment_amount').value = amt || '';
        document.getElementById('payment_status').value = 'paid';

        const dataObj = collectFormObject();
        const resJson = await submitFormToServer(dataObj);
        if (resJson && (resJson.status === 'ok' || resJson.success)) {
          successMessage.style.display = 'block';
          errorMessage.style.display = 'none';
          form.reset();
          wordCount.textContent = '0';
          toggleSections(); handleAccuracyExplanation(); toggleGenderOtherInput();
        } else {
          alert('Payment succeeded but final submission failed: ' + JSON.stringify(resJson));
        }
      } else if (finalStatus?.outcome === 'failed') {
        alert('Payment failed. Your request remains pending. You can retry the payment.');
      } else {
        alert('Payment status not confirmed yet. If you completed payment, we will email you once it clears.');
      }
    });

    // --------------- SUBMIT HANDLER ---------------
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate form before proceeding
      if (!validateForm()) {
        errorMessage.textContent = 'Please fill in all required fields correctly.';
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
        
        // Scroll to first error
        const firstError = document.querySelector('.validation-error');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
      }

      const text = expectations.value;
      const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
      if (words > 5000) {
        alert('Your expectations explanation exceeds the 5000 word limit. Please shorten it.');
        expectations.focus();
        return;
      }

      const purpose = getCurrentPurpose();

      if (purpose === 'Astrology') {
        if (!genderOtherInputWrapper.classList.contains('hide') && (!genderOtherInput.value || genderOtherInput.value.trim() === '')) {
          alert('Please specify your gender in the provided field.');
          genderOtherInput.focus();
          return;
        }

        if (!termsAgree || !termsAgree.checked) {
          alert('Please agree to the Terms and Conditions before submitting for Astrology service.');
          if (termsAgree) termsAgree.focus();
          return;
        }
      }

      const submitButton = document.getElementById('submitBtn');
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'Processing...';

      try {
        const purpose = getCurrentPurpose();

        if (purpose === 'Astrology') {
          // ASTROLOGY CONSULTATION FLOW - WITH PAYMENT
          
          // Save form data immediately (pending)
          const saved = await saveFormDataImmediately();
          if (!saved) {
            console.warn('Failed to save form data initially, but continuing with payment...');
          }

          const amountINR = getSelectedAstroAmount();
          if (!amountINR || amountINR <= 0) throw new Error('Invalid selected amount for Astrology.');

          const orderResp = await createPhonePePayment(amountINR);
          console.log("createPhonePePayment returned:", orderResp);

          // NEW: robust transaction id extraction
          const transactionId = extractTxnId(orderResp);

          // Extract checkout URL
          const checkoutUrl = extractCheckoutUrl(orderResp) || null;

          console.log("transactionId:", transactionId, "checkoutUrl:", checkoutUrl);

          if (!checkoutUrl) {
            console.warn('Full PhonePe response:', orderResp);
            throw new Error('No checkout URL returned by server. Inspect server response in console.');
          }

          // ---------- OPEN GATEWAY IN SAME TAB & RETURN ----------
          sessionStorage.setItem('pp_txn_id', transactionId || '');
          sessionStorage.setItem('pp_amt', String(amountINR));
          openPhonePeCheckout(checkoutUrl, /* inNewTab = */ false);
          return; // Stop further code; will resume after redirect back

        } else {
          // OTHER PURPOSE FLOW - DIRECT SUBMISSION WITHOUT PAYMENT
          document.getElementById('phonepe_txn_id').value = '';
          document.getElementById('phonepe_order_id').value = '';
          document.getElementById('payment_amount').value = '0';
          document.getElementById('payment_status').value = 'not applicable';
          document.getElementById('astro_service_tier').value = 'not applicable';

          const dataObj = collectFormObject();
          dataObj.payment_amount = '0';
          dataObj.payment_status = 'not applicable';
          dataObj.astro_service_tier = 'not applicable';
          dataObj.phonepe_txn_id = '';
          dataObj.phonepe_order_id = '';

          const resJson = await submitFormToServer(dataObj);
          if (resJson && (resJson.status === 'ok' || resJson.success)) {
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            form.reset();
            wordCount.textContent = '0';
            toggleSections();
            handleAccuracyExplanation();
            toggleGenderOtherInput();
          } else {
            throw new Error('Server replied: ' + JSON.stringify(resJson));
          }
        }
      } catch (err) {
        console.error('Submission failed:', err);
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
        alert('Error: ' + (err.message || err));
      } finally {
        submitButton.textContent = originalText;
        submitButton.disabled = false;
        paymentModal.style.display = 'none';
        window.scrollTo(0, 0);
      }
    });
  </script>
</body>
</html>
