<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Let's Connect</title>

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Open+Sans:wght@400;500;600;700&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
    html, body { height: 100%; }
    body { font-family: 'Lora', serif; background: linear-gradient(to bottom, rgba(220, 220, 220, 0.95), rgba(245, 245, 245, 0.95)), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="%230987b5" opacity="0.05"/></svg>'); background-size: 150px; color: #333; line-height: 1.6; padding: 20px; min-height: 100vh; }
    nav { background: linear-gradient(135deg, #0987b5, #076a91); padding: 6px 3%; display: flex; justify-content: center; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1); position: sticky; top: 0; margin-left:0px;margin-right:0px; z-index: 100; }
    .nav-links { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 1600px; width: 100%; }
    nav a { padding: 5px 11px; color: #e8f4ff; text-decoration: none; font-family: 'Open Sans', sans-serif; font-weight: 600; font-size: 0.95rem; border-radius: 30px; transition: all 0.25s ease; border: 1px solid rgba(255, 255, 255, 0.12); text-align: center; background: rgba(255, 255, 255, 0.06); transform: scale(0.8); }
    nav a:hover { background-color: white; color: #0987b5; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
    nav a.active { background-color: rgba(255, 255, 255, 0.28); border-color: rgba(255, 255, 255, 0.4); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12); }
    .container { max-width: 1000px; margin: 20px auto; background: linear-gradient(to bottom, #ffffff, #fbfeff); padding: 32px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.08); }
    .header { text-align: center; margin-bottom: 12px; }
    .header h1 { color: #076a91; margin-bottom: 8px; font-size: 30px; font-family: 'Open Sans', sans-serif; }
    .header p { color: #5a9ec9; font-size: 16px; }
    .form-section { margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .form-section h2 { color: #076a91; margin-bottom: 10px; font-size: 20px; display: flex; align-items: center; font-family: 'Open Sans', sans-serif; }
    .form-section h2::before { content: "✦"; margin-right: 10px; font-size: 20px; color: rgba(9,135,181,0.9); }
    .form-group { margin-bottom: 10px; }
    label { display: block; margin-bottom: 4px; font-weight: 600; color: #2c3e50; font-family: 'Open Sans', sans-serif; }
    .required::after { content: " *"; color: #e74c3c; }
    input, select, textarea { width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; transition: all 0.2s; font-family: inherit; }
    input:focus, select:focus, textarea:focus { border-color: #0987b5; outline: none; box-shadow: 0 0 0 3px rgba(9,135,181,0.10); }
    .radio-group { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 4px; }
    .radio-option { display: flex; align-items: center; gap: 6px; font-family: 'Open Sans', sans-serif; color: #33475b; }
    .time-fields { display: flex; gap: 12px; }
    .time-fields .form-group { flex: 1; }
    .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
    button { padding: 12px 20px; background: linear-gradient(90deg,#0987b5,#5ac3f0); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 6px 18px rgba(9,135,181,0.18); }
    button:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(9,135,181,0.20); }
    .success-message { background-color: #d4edda; color: #155724; padding: 12px; border-radius: 8px; margin-bottom: 14px; display: none; text-align: center; }
    .error-message { background-color: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-bottom: 14px; display: none; text-align: center; }
    .word-count { text-align: right; font-size: 13px; color: #7f8c8d; margin-top: 6px; }
    .disabled-section { opacity: 0.6; pointer-events: none; }
    .disabled-field { background-color: #f0f0f0; cursor: not-allowed; color: #7f8c8d; }
    .centered-section { max-width: 760px; margin-left: auto; margin-right: auto; }
    .action-buttons { display: flex; justify-content: center; gap: 16px; margin-top: 18px; }
    .hide { display: none; }
    input[type="number"].time-input { width: 100%; padding: 8px; }
    .consultation-note { background-color: #f8f9fa; border-left: 4px solid #0987b5; padding: 12px 16px; margin: 12px 0; border-radius: 4px; font-size: 14px; color: #2c3e50; display: none; }
    
    /* Payment processing modal */
    .payment-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    .payment-modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      text-align: center;
    }
    .payment-modal h3 {
      color: #076a91;
      margin-bottom: 15px;
    }
    .payment-modal p {
      margin-bottom: 20px;
      color: #555;
    }
    .payment-processing {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    .payment-processing .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #0987b5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 900px) { .two-column { grid-template-columns: 1fr; } .centered-section { max-width: 100%; padding: 0 8px; } .time-fields { flex-direction: row; gap: 10px; } button { width: 48%; } }
    @page { size: A4; margin: 10mm; }
    @media print { html, body { background: white !important; color: #000 !important; width: 100% !important; height: auto !important; overflow: visible !important; padding: 0 !important; margin: 0 !important; font-size: 12px !important; } .container { box-shadow: none !important; border-radius: 0 !important; max-width: 100% !important; width: 100% !important; margin: 0 !important; padding: 5mm !important; background: white !important; page-break-inside: avoid; } .header h1 { font-size: 20px !important; margin-bottom: 4px !important; } .header p { font-size: 12px !important; color: #333 !important; margin-bottom: 8px !important; } .form-section { margin-bottom: 8px !important; padding-bottom: 6px !important; page-break-inside: avoid; } .form-group { margin-bottom: 6px !important; } .two-column { grid-template-columns: 1fr 1fr !important; gap: 10px !important; page-break-inside: avoid; } .time-fields { display: flex !important; gap: 2px !important; width: 60% !important; } .time-fields .form-group { flex: 1 !important; margin-bottom: 0 !important; } input[type="number"].time-input { width: 80% !important; padding: 4px !important; font-size: 12px !important; } [style*="margin-left"] { margin-left: 0 !important; } [style*="width:160%"], [style*="width:120%"] { width: 100% !important; } input, select, textarea { width: 100% !important; border: 1px solid #999 !important; box-shadow: none !important; background: transparent !important; color: #000 !important; padding: 4px 6px !important; font-size: 12px !important; page-break-inside: avoid; } textarea { max-width: 100% !important; min-height: 50px !important; } button, .action-buttons { display: none !important; } .success-message, .error-message { display: none !important; } .consultation-note { display: block !important; background-color: transparent !important; border-left: 2px solid #0987b5 !important; padding: 6px 8px !important; margin: 8px 0 !important; font-size: 11px !important; color: #000 !important; page-break-inside: avoid; } .radio-group { gap: 8px !important; flex-wrap: nowrap !important; } .radio-option { white-space: nowrap !important; font-size: 12px !important; } #birth-details-section { margin-left: 0 !important; } .form-section h2 { font-size: 16px !important; margin-bottom: 6px !important; } label { font-size: 12px !important; margin-bottom: 2px !important; } input[type="date"] { width: 36% !important; } .word-count { font-size: 10px !important; margin-top: 2px !important; } .centered-section { max-width: 100% !important; padding: 0 !important; } #gender-other-input-wrapper { margin-left: 0 !important; } .form-section, .two-column, .time-fields { page-break-inside: avoid; } }
  </style>
</head>
<body>
  <nav>
    <div class="nav-links">
      <a href="https://kishoredvr.github.io/Exploring/">Home</a>
      <a href="https://kishoredvr.github.io/Exploring/AboutMe.html">Origin Of Thoughts</a>
      <a href="https://parishodana.xyz/Articles.html">My Articles</a>
      <a href="https://kishoredvr.github.io/Exploring/MessageMe.html" class="active">Let's Connect</a>
    </div>
  </nav>

  <div class="container">
    <div class="header">
      <h1>Let's Connect</h1>
      <p>Your detailed and thoughtful information will help us give you the best possible response</p>
    </div>

    <div id="successMessage" class="success-message">Thank you! Your consultation request has been submitted successfully.</div>
    <div id="errorMessage" class="error-message">There was an error submitting your request. Please try again.</div>

    <form id="astrology-consultation-form" novalidate>
      <div class="form-section always-enabled centered-section" style="text-align: center;">
        <div style="display:flex;align-items:center;justify-content:center;gap:18px;flex-wrap:wrap;">
          <h2 style="margin:0;">Purpose</h2>
          <div class="radio-group" aria-label="Purpose">
            <label class="radio-option"><input type="radio" id="purpose-astrology" name="purpose" value="Astrology" required checked> Astrology Consultation</label>
            <label class="radio-option"><input type="radio" id="purpose-other" name="purpose" value="Other"> Other Purpose</label>
          </div>
        </div>

        <div id="consultationNote" class="consultation-note">
          <strong>Note:</strong> Select a service tier below and pay the applicable fee.
        </div>

        <div id="astroServiceWrapper" class="form-group centered-section" style="max-width:380px; margin: 12px auto 0; display:none;">
          <label for="astroServiceSelect">Choose Astrology Service</label>
          <select id="astroServiceSelect" name="astroServiceSelect">
          <option value="10" selected>TestRun — ₹10</option>
          <option value="1000">Basic — ₹1000</option>
          <option value="2000">Detailed — ₹2000</option>
          <option value="5000">Premium — ₹5000</option>
          </select>
        </div>
      </div>

      <div class="form-section centered-section">
        <h2>Contact Information</h2>
        <div class="two-column">
          <div class="form-group">
            <label for="name" class="required">Full Name</label>
            <input type="text" id="name" name="name" required>
          </div>

          <div class="form-group">
            <label for="email" class="required">Email Address</label>
            <input type="email" id="email" name="email" required>
          </div>
        </div>
        
        <!-- Added mobile number field for PhonePe payment -->
        <div class="form-group">
          <label for="mobileNumber" class="required">Mobile Number (for Payment)</label>
          <input type="tel" id="mobileNumber" name="mobileNumber" required>
        </div>
      </div>

      <div class="two-column">
        <div>
          <div class="form-section" id="birth-details-section" style="margin-left:90px;">
            <h2>Birth Details</h2>
            <div class="form-group">
              <label for="birthDetailsAvailable" class="required">Are your birth details available?</label>
              <div class="radio-group">
                <label class="radio-option"><input type="radio" id="birth-yes" name="birthDetailsAvailable" value="Yes" required> Yes</label>
                <label class="radio-option"><input type="radio" id="birth-no" name="birthDetailsAvailable" value="No"> No</label>
              </div>
            </div>

            <div class="form-group">
              <label for="dob">Date of Birth</label>
              <input type="date" id="dob" name="dob" style="width:40%;">
            </div>

            <div class="form-group">
              <label for="tob" style="margin-bottom:-2px;">Time of Birth</label>
              <div class="time-fields">
                <div class="form-group">
                  <label for="hour" style="margin-left:8px;">Hrs</label>
                  <input type="number" id="hour" name="hour" min="0" max="23" placeholder="HH" class="time-input" style="width:50%;">
                </div>
                <div class="form-group">
                  <label for="minute" style="margin-left:-60px;">Mins</label>
                  <input type="number" id="minute" name="minute" min="0" max="59" placeholder="MM" class="time-input" style="width:50%;margin-left:-60px;">
                </div>
                <div class="form-group">
                  <label for="second" style="margin-left:-120px;">Secs</label>
                  <input type="number" id="second" name="second" min="0" max="59" placeholder="SS" class="time-input" style="width:50%;margin-left:-120px;">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="explanation" id="explanation-label" style="display:none;">Please explain why the details might not be accurate</label>
              <textarea id="explanation" name="explanation" rows="3" style="display:none;" placeholder="Please provide explanation here..."></textarea>
            </div>
          </div>
        </div>

        <div>
          <div class="form-section" id="birth-location-section">
            <h2>Birth Location</h2>
            <div class="form-group">
              <label for="city" class="required">City/Village</label>
              <input type="text" id="city" name="city" required>
            </div>
            <div class="form-group">
              <label for="state" class="required">State/Province</label>
              <input type="text" id="state" name="state" required>
            </div>
            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div><br>
                <label for="country" class="required">Country</label>
                <input type="text" id="country" name="country" required>
              </div>
              <div><br>
                <label for="pincode" class="required">Pincode</label>
                <input type="text" id="pincode" name="pincode" required>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="two-column">
        <div>
          <div class="form-group" style="margin-left:90px;">
            <label for="gender" class="required">Gender</label>
            <div class="radio-group" role="radiogroup" aria-labelledby="gender">
              <label class="radio-option"><input type="radio" id="gender-male" name="gender" value="Male" required> Male</label>
              <label class="radio-option"><input type="radio" id="gender-female" name="gender" value="Female"> Female</label>
              <label class="radio-option"><input type="radio" id="gender-other" name="gender" value="Other"> Other</label>
            </div>

            <div id="gender-other-input-wrapper" class="form-group hide" style="margin-top:4px;">
              <label for="genderOtherInput">Please explain for better understanding</label>
              <input type="text" id="genderOtherInput" name="genderOtherInput" placeholder="Explanation">
            </div>
          </div>
        </div>

        <div>
          <div class="form-group" id="accuracy-section">
            <label for="accuracy" class="required">Are the birth details provided accurate?</label>
            <div class="radio-group">
              <label class="radio-option"><input type="radio" id="accuracy-yes" name="accuracy" value="Yes" required> Yes</label>
              <label class="radio-option"><input type="radio" id="accuracy-no" name="accuracy" value="No"> No</label>
            </div>
          </div>
        </div>
      </div>

      <div class="form-section always-enabled centered-section" style="margin-top: 12px;">
        <div class="form-group" id="country-field">
          <label for="contactCountry" class="required">Which country you belong to?</label>
          <input type="text" id="contactCountry" name="contactCountry" required>
        </div>
      </div>

      <div class="form-section always-enabled centered-section" style="margin-top: 12px;">
        <h2>Let me know your intentions for contacting me</h2>
        <div class="form-group">
          <textarea id="expectations" name="expectations" rows="6" required placeholder="Please describe your intentions and expectations in detail..."></textarea>
          <div class="word-count">Maximum 5000 words: <span id="wordCount">0</span>/5000</div>
        </div>
      </div>

      <div id="termsWrapper" class="form-section centered-section" style="display:none; margin-top:8px;">
        <div class="form-group" style="display:flex;align-items:center;gap:10px;">
          <input type="checkbox" id="termsAgree" name="termsAgree" style="width:5%;"/>
          <label for="termsAgree" style="font-weight:600;">I agree to the <a href="https://parishodana.xyz/Terms.html" id="termsLink" target="_blank" rel="noopener noreferrer">Terms and Conditions</a>.</label>
        </div>
      </div>

      <div class="action-buttons">
        <button id="clearButton" type="button" style="background:#ccc;color:#222;">Clear All</button>
        <button id="submitBtn" type="submit">Submit Consultation Request</button>
      </div>

      <!-- Hidden fields for PhonePe payment result (server will verify) -->
      <input type="hidden" name="phonepe_txn_id" id="phonepe_txn_id" />
      <input type="hidden" name="phonepe_order_id" id="phonepe_order_id" />
      <input type="hidden" name="payment_amount" id="payment_amount" />
      <input type="hidden" name="payment_status" id="payment_status" />
      <input type="hidden" name="astro_service_tier" id="astro_service_tier" />
    </form>
  </div>

  <!-- Payment Processing Modal -->
  <div class="payment-modal" id="paymentModal">
    <div class="payment-modal-content">
      <h3>Processing Payment</h3>
      <p>Please wait while we redirect you to PhonePe for secure payment processing.</p>
      <div class="payment-processing">
        <div class="spinner"></div>
      </div>
      <p>Do not refresh or close this window.</p>
    </div>
  </div>

  <script>
    // Set this to your Supabase Functions base URL (or other server that exposes these endpoints).
    // Example: const BACKEND_BASE = 'https://lkvcbpxkpwpoqjlcddgl.functions.supabase.co';
    const BACKEND_BASE = 'https://lkvcbpxkpwpoqjlcddgl.functions.supabase.co'; // <-- replace with your functions domain

    // All client code uses BACKEND_BASE now
    const form = document.getElementById('astrology-consultation-form');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const paymentModal = document.getElementById('paymentModal');

    const accuracyYes = document.getElementById('accuracy-yes');
    const accuracyNo = document.getElementById('accuracy-no');
    const explanation = document.getElementById('explanation');
    const explanationLabel = document.getElementById('explanation-label');

    const expectations = document.getElementById('expectations');
    const wordCount = document.getElementById('wordCount');

    const purposeAstrology = document.getElementById('purpose-astrology');
    const purposeOther = document.getElementById('purpose-other');
    const consultationNote = document.getElementById('consultationNote');

    const birthDetailsSection = document.getElementById('birth-details-section');
    const birthLocationSection = document.getElementById('birth-location-section');
    const contactCountryField = document.getElementById('contactCountry');
    const accuracySection = document.getElementById('accuracy-section');
    const clearButton = document.getElementById('clearButton');

    const genderMale = document.getElementById('gender-male');
    const genderFemale = document.getElementById('gender-female');
    const genderOther = document.getElementById('gender-other');
    const genderOtherInputWrapper = document.getElementById('gender-other-input-wrapper');
    const genderOtherInput = document.getElementById('genderOtherInput');

    const astroServiceWrapper = document.getElementById('astroServiceWrapper');
    const astroServiceSelect = document.getElementById('astroServiceSelect');
    const astroServiceTierHidden = document.getElementById('astro_service_tier');

    const termsWrapper = document.getElementById('termsWrapper');
    const termsAgree = document.getElementById('termsAgree');

    function toggleSections() {
      if (purposeOther.checked) {
        birthDetailsSection.classList.add('disabled-section');
        birthLocationSection.classList.add('disabled-section');
        accuracySection.classList.add('disabled-section');
        consultationNote.style.display = 'none';

        document.querySelectorAll('#birth-details-section input, #birth-details-section select, #birth-location-section input').forEach(field => {
          field.removeAttribute('required');
        });

        document.querySelectorAll('#accuracy-section input').forEach(field => {
          field.removeAttribute('required');
          field.setAttribute('disabled', 'true');
        });

        explanation.style.display = 'none';
        explanationLabel.style.display = 'none';
        explanation.removeAttribute('required');

        contactCountryField.classList.remove('disabled-field');
        contactCountryField.removeAttribute('disabled');
        contactCountryField.setAttribute('required', 'true');

        astroServiceWrapper.style.display = 'none';
        astroServiceTierHidden.value = '';

        if (termsWrapper) {
          termsWrapper.style.display = 'none';
          termsAgree.checked = false;
          termsAgree.removeAttribute('required');
        }
      } else {
        birthDetailsSection.classList.remove('disabled-section');
        birthLocationSection.classList.remove('disabled-section');
        accuracySection.classList.remove('disabled-section');
        consultationNote.style.display = 'block';

        document.querySelectorAll('#birth-details-section [name="birthDetailsAvailable"]').forEach(field => {
          field.setAttribute('required', 'true');
        });
        document.querySelectorAll('#birth-location-section [required]').forEach(field => {
          field.setAttribute('required', 'true');
        });

        document.querySelectorAll('#accuracy-section input').forEach(field => {
          field.removeAttribute('disabled');
          field.setAttribute('required', 'true');
        });

        contactCountryField.classList.add('disabled-field');
        contactCountryField.setAttribute('disabled', 'true');
        contactCountryField.removeAttribute('required');

        astroServiceWrapper.style.display = 'block';
        astroServiceTierHidden.value = astroServiceSelect.value;

        if (termsWrapper) {
          termsWrapper.style.display = 'block';
          termsAgree.setAttribute('required', 'true');
        }
      }
    }

    function handleAccuracyExplanation() {
      if (accuracyNo.checked) {
        explanation.style.display = 'block';
        explanationLabel.style.display = 'block';
        explanation.setAttribute('required', 'true');
      } else {
        explanation.style.display = 'none';
        explanationLabel.style.display = 'none';
        explanation.removeAttribute('required');
      }
    }

    function toggleGenderOtherInput() {
      if (genderOther.checked) {
        genderOtherInputWrapper.classList.remove('hide');
        genderOtherInput.setAttribute('required', 'true');
      } else {
        genderOtherInputWrapper.classList.add('hide');
        genderOtherInput.removeAttribute('required');
        genderOtherInput.value = '';
      }
    }

    toggleSections();
    handleAccuracyExplanation();
    toggleGenderOtherInput();

    purposeAstrology.addEventListener('change', toggleSections);
    purposeOther.addEventListener('change', toggleSections);

    accuracyYes.addEventListener('change', handleAccuracyExplanation);
    accuracyNo.addEventListener('change', handleAccuracyExplanation);

    genderMale.addEventListener('change', toggleGenderOtherInput);
    genderFemale.addEventListener('change', toggleGenderOtherInput);
    genderOther.addEventListener('change', toggleGenderOtherInput);

    astroServiceSelect.addEventListener('change', () => {
      astroServiceTierHidden.value = astroServiceSelect.value;
    });

    expectations.addEventListener('input', () => {
      const text = expectations.value;
      const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
      wordCount.textContent = words;
      if (words > 5000) {
        wordCount.style.color = '#e74c3c';
        expectations.style.borderColor = '#e74c3c';
      } else {
        wordCount.style.color = '#7f8c8d';
        expectations.style.borderColor = '#ddd';
      }
    });

    clearButton.addEventListener('click', () => {
      form.reset();
      wordCount.textContent = '0';
      explanation.style.display = 'none';
      explanationLabel.style.display = 'none';
      explanation.removeAttribute('required');

      genderOtherInputWrapper.classList.add('hide');
      genderOtherInput.removeAttribute('required');
      genderOtherInput.value = '';

      if (termsAgree) {
        termsAgree.checked = false;
        termsAgree.removeAttribute('required');
      }

      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';

      toggleSections();
      handleAccuracyExplanation();
      toggleGenderOtherInput();

      window.scrollTo(0, 0);
    });

    function formDataFromForm() {
      return new FormData(form);
    }

    function getSelectedAstroAmount() {
      const purpose = document.querySelector('input[name="purpose"]:checked')?.value || 'Astrology';
      if (purpose !== 'Astrology') return 0;

      const sel = document.getElementById('astroServiceSelect');
      if (!sel) return 1000;

      const opt = sel.options[sel.selectedIndex];
      if (!opt) return 1000;

      const raw = (opt.getAttribute('data-amt') ?? opt.value ?? '').toString().trim();
      const amt = parseFloat(raw.replace(/[^\d.-]/g, ''));
      const final = (isFinite(amt) && amt > 0) ? Math.round(amt) : 1000;
      console.log('getSelectedAstroAmount -> raw:', raw, 'parsed:', amt, 'final (rupees):', final);
      return final;
    }

    // ---------------- Backend helpers (now using BACKEND_BASE) ----------------

    // NEW FUNCTION: Save form data immediately before payment
    async function saveFormDataImmediately() {
        const formData = collectFormObject();
        formData.payment_status = 'pending'; // Mark as pending payment
        
        try {
            const response = await fetch(BACKEND_BASE + '/submit-form', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            return response.ok;
        } catch (error) {
            console.error('Failed to save form data:', error);
            return false;
        }
    }

    async function createPhonePePayment(amountINR) {
      if (!BACKEND_BASE || BACKEND_BASE.includes('your-backend-url')) {
        throw new Error('Please configure BACKEND_BASE with your backend URL.');
      }
      const amountPaise = Number(amountINR) * 100;
      const body = {
        amount: amountPaise,
        userId: document.getElementById('email').value,
        mobileNumber: document.getElementById('mobileNumber').value,
        redirectUrl: BACKEND_BASE + '/return-handler'
      };
      const url = BACKEND_BASE + '/initiate-payment';
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error('Payment initiation failed: ' + text);
      }
      const json = await res.json();
      if (!json || !json.success) {
        throw new Error('Payment initiation failed: ' + (json && (json.error || json.message) ? (json.error || json.message) : JSON.stringify(json)));
      }
      return json;
    }

    const checkPaymentStatus = async (transactionId) => {
      if (!BACKEND_BASE || BACKEND_BASE.includes('your-backend-url')) {
        throw new Error('Please configure BACKEND_BASE with your backend URL.');
      }
      const statusUrl = `${BACKEND_BASE}/payment-status?txn=${encodeURIComponent(transactionId)}`;
      const resp = await fetch(statusUrl, { method: 'GET' });
      if (!resp.ok) {
        const text = await resp.text();
        throw new Error('Status check failed: ' + text);
      }
      return resp.json();
    };

    async function checkPaymentStatusDetailed(transactionId) {
      if (!BACKEND_BASE || BACKEND_BASE.includes('your-backend-url')) {
        return { ok: false, error: 'BACKEND_BASE not configured' };
      }
      const statusUrl = `${BACKEND_BASE}/payment-status?txn=${encodeURIComponent(transactionId)}`;
      try {
        const resp = await fetch(statusUrl, { method: 'GET' });
        const txt = await resp.text().catch(() => "");
        let body = null;
        try { body = txt ? JSON.parse(txt) : null; } catch (e) { body = { raw: txt }; }
        return { ok: resp.ok, status: resp.status, body };
      } catch (err) {
        return { ok: false, error: String(err) };
      }
    }

    // ---------- NEW: robust redirect extractor ----------
    function extractCheckoutUrl(orderResp) {
      const r = orderResp?.data && typeof orderResp.data === 'object' ? orderResp.data : orderResp;
      return (
        r?.data?.instrumentResponse?.redirectInfo?.url ||
        r?.data?.redirectInfo?.url ||
        r?.data?.checkoutUrl ||
        r?.redirectInfo?.url ||
        r?.redirectUrl ||
        r?.data?.checkout?.redirectUrl ||
        null
      );
    }

    // ---------------- collect & submit ----------------

    function collectFormObject() {
      const fields = [
        "name","email","mobileNumber",
        "purpose","astroServiceSelect","astro_service_tier",
        "birthDetailsAvailable","dob","hour","minute","second","explanation",
        "city","state","country","pincode",
        "gender","genderOtherInput",
        "accuracy",
        "contactCountry",
        "expectations",
        "phonepe_txn_id","phonepe_order_id","payment_amount","payment_status"
      ];

      const out = {};
      function readRadio(name) {
        const r = document.querySelector(`input[name="${name}"]:checked`);
        return r ? r.value : null;
      }

      try {
        if (astroServiceSelect && astroServiceSelect.value) {
          astroServiceTierHidden.value = astroServiceSelect.value;
        }
      } catch(e){}

      for (const idOrName of fields) {
        let el = document.getElementById(idOrName);
        if (!el) {
          const byName = document.getElementsByName(idOrName);
          if (byName && byName.length === 1) el = byName[0];
        }

        let val = null;
        if (el) {
          if (el.type === "radio") {
            val = readRadio(el.name || idOrName);
          } else {
            val = el.value;
          }
        } else {
          const rVal = readRadio(idOrName);
          if (rVal !== null) val = rVal;
        }

        if ((idOrName === "gender") && !val) {
          const g = readRadio("gender");
          if (g === "Other") {
            const other = document.getElementById("genderOtherInput");
            if (other && other.value) val = `Other: ${other.value}`;
            else val = "Other";
          }
        }

        if (val === null || val === undefined || String(val).trim() === "") {
          out[idOrName] = "Not applicable";
        } else {
          out[idOrName] = String(val).trim();
        }
      }

      out.submittedAt = new Date().toISOString();
      return out;
    }

    async function submitFormToServer(formObj) {
      if (!BACKEND_BASE || BACKEND_BASE.includes('your-backend-url')) {
        throw new Error('Please configure BACKEND_BASE with your backend URL.');
      }

      const url = BACKEND_BASE + '/submit-form';
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formObj)
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error('Submission failed: ' + text);
      }
      return res.json();
    }

    function openPhonePeCheckout(url, inNewTab = true) {
      if (!url) throw new Error('Invalid PhonePe checkout URL');
      paymentModal.style.display = 'flex';
      
      if (inNewTab) {
        window.open(url, '_blank');
      } else {
        window.location.href = url;
      }
      
      setTimeout(() => {
        paymentModal.style.display = 'none';
      }, 5000);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const text = expectations.value;
      const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
      if (words > 5000) {
        alert('Your expectations explanation exceeds the 5000 word limit. Please shorten it.');
        expectations.focus();
        return;
      }

      if (!genderOtherInputWrapper.classList.contains('hide') && (!genderOtherInput.value || genderOtherInput.value.trim() === '')) {
        alert('Please specify your gender in the provided field.');
        genderOtherInput.focus();
        return;
      }

      const purpose = document.querySelector('input[name="purpose"]:checked')?.value || 'Astrology';

      if (purpose === 'Astrology') {
        if (!termsAgree || !termsAgree.checked) {
          alert('Please agree to the Terms and Conditions before submitting for Astrology service.');
          if (termsAgree) termsAgree.focus();
          return;
        }
      }

      const submitButton = document.getElementById('submitBtn');
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'Processing...';

      try {
        const purpose = document.querySelector('input[name="purpose"]:checked')?.value || 'Astrology';

        if (purpose === 'Astrology') {
          // ASTROLOGY CONSULTATION FLOW - WITH PAYMENT
          
          // === ADD THIS: Save form data immediately ===
          const saved = await saveFormDataImmediately();
          if (!saved) {
            console.warn('Failed to save form data initially, but continuing with payment...');
          }
          // === END ADDITION ===

          const amountINR = getSelectedAstroAmount();
          if (!amountINR || amountINR <= 0) throw new Error('Invalid selected amount for Astrology.');

          const orderResp = await createPhonePePayment(amountINR);
          console.log("createPhonePePayment returned:", orderResp);

          const transactionId = orderResp.transactionId;

          // ---------- use robust extractor ----------
          const checkoutUrl = extractCheckoutUrl(orderResp) || null;

          console.log("transactionId:", transactionId, "checkoutUrl:", checkoutUrl);

          if (!checkoutUrl) {
            console.warn('Full PhonePe response:', orderResp);
            throw new Error('No checkout URL returned by server. Inspect server response in console.');
          }

          // ---------- Move tab opening code HERE (only for Astrology flow) ----------
          let payWin = null;
          try {
            payWin = window.open('', '_blank');
            if (payWin) {
              payWin.document.write('<p style="font:14px system-ui;margin:16px">Opening PhonePe…</p>');
            }
          } catch (_) {}

          // ---------- navigate the pre-opened tab (or fallback to same-tab) ----------
          if (payWin) {
            try { payWin.location.replace(checkoutUrl); }
            catch { window.location.assign(checkoutUrl); }
          } else {
            window.location.assign(checkoutUrl);
          }

          // Poll server to verify payment final state (unchanged)
          let attempts = 0;
          const maxAttempts = 60;
          const pollIntervalMs = 5000;
          let finalStatus = null;

          if (transactionId) {
            while (attempts < maxAttempts) {
              attempts++;
              try {
                const stResp = await checkPaymentStatusDetailed(transactionId);
                console.log("payment-status attempt", attempts, stResp);

                if (stResp.ok && stResp.body) {
                  const payload = stResp.body.data || stResp.body || {};
                  const state =
                    payload?.status ||
                    payload?.state ||
                    payload?.data?.transaction?.state ||
                    payload?.data?.state ||
                    payload?.data?.transaction?.status ||
                    payload?.transaction?.state ||
                    null;

                  const stateStr = state ? String(state).toLowerCase() : "";

                  if (stateStr && (stateStr.includes('success') || stateStr.includes('paid') || stateStr.includes('completed'))) {
                    finalStatus = { outcome: 'success', payload: stResp.body };
                    break;
                  }
                  if (stateStr && (stateStr.includes('failed') || stateStr.includes('error'))) {
                    finalStatus = { outcome: 'failed', payload: stResp.body };
                    break;
                  }

                  if (stResp.body && (stResp.body.success === true || stResp.body.status === 'ok' || stResp.body.paid === true)) {
                    finalStatus = { outcome: 'success', payload: stResp.body };
                    break;
                  }
                } else {
                  console.warn('payment-status non-ok response', stResp);
                }
              } catch (err) {
                console.warn('poll error', err);
              }
              await new Promise(r => setTimeout(r, pollIntervalMs));
            }
          } else {
            console.warn('No transactionId returned from initiate-payment; skipping polling.');
          }

          if (finalStatus && finalStatus.outcome === 'success') {
            try {
              let extractedTxn = "";
              try {
                extractedTxn =
                  finalStatus.payload?.data?.phonepeResponse?.data?.transactionId ||
                  finalStatus.payload?.data?.transactionId ||
                  finalStatus.payload?.transactionId ||
                  finalStatus.payload?.data?.phonepeResponse?.data?.orderId ||
                  "";
              } catch (e) {}
              document.getElementById('phonepe_txn_id').value = extractedTxn || "";
            } catch (e) {}
            document.getElementById('phonepe_order_id').value = transactionId;
            document.getElementById('payment_amount').value = amountINR;
            document.getElementById('payment_status').value = 'paid';

            const dataObj = collectFormObject();
            const resJson = await submitFormToServer(dataObj);
            if (resJson && (resJson.status === 'ok' || resJson.success)) {
              successMessage.style.display = 'block';
              errorMessage.style.display = 'none';
              form.reset();
              wordCount.textContent = '0';
              toggleSections();
              handleAccuracyExplanation();
              toggleGenderOtherInput();
            } else {
              throw new Error('Server replied: ' + JSON.stringify(resJson));
            }
          } else {
            try {
              document.getElementById('phonepe_order_id').value = transactionId || '';
              document.getElementById('payment_amount').value = amountINR;
              document.getElementById('payment_status').value = 'unpaid';

              const dataObj = collectFormObject();
              dataObj.payment_status = 'unpaid';
              const res = await submitFormToServer(dataObj);
              console.log('Submitted unpaid fallback:', res);
              alert('Payment was not completed. Your request has been submitted as unpaid — we will contact you.');
              successMessage.style.display = 'block';
              errorMessage.style.display = 'none';
              form.reset();
              wordCount.textContent = '0';
              toggleSections();
              handleAccuracyExplanation();
              toggleGenderOtherInput();
            } catch (e) {
              console.error('Failed to submit unpaid fallback:', e);
              errorMessage.style.display = 'block';
              successMessage.style.display = 'none';
              alert('There was an issue submitting your request after payment was not confirmed. Please contact us.');
            }
          }

        } else {
          // OTHER PURPOSE FLOW - DIRECT SUBMISSION WITHOUT PAYMENT
          document.getElementById('phonepe_txn_id').value = '';
          document.getElementById('phonepe_order_id').value = '';
          document.getElementById('payment_amount').value = '0';
          document.getElementById('payment_status').value = 'not applicable';
          document.getElementById('astro_service_tier').value = 'not applicable';

          const dataObj = collectFormObject();
          dataObj.payment_amount = '0';
          dataObj.payment_status = 'not applicable';
          dataObj.astro_service_tier = 'not applicable';
          dataObj.phonepe_txn_id = '';
          dataObj.phonepe_order_id = '';

          const resJson = await submitFormToServer(dataObj);
          if (resJson && (resJson.status === 'ok' || resJson.success)) {
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            form.reset();
            wordCount.textContent = '0';
            toggleSections();
            handleAccuracyExplanation();
            toggleGenderOtherInput();
          } else {
            throw new Error('Server replied: ' + JSON.stringify(resJson));
          }
        }
      } catch (err) {
        console.error('Submission failed:', err);
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
        alert('Error: ' + (err.message || err));
      } finally {
        submitButton.textContent = originalText;
        submitButton.disabled = false;
        paymentModal.style.display = 'none';
        window.scrollTo(0, 0);
      }
    });
  </script>
</body>
</html>
